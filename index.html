<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <title>Facade View</title>
    <!-- CSS  -->
    <link href="css/swiper.css" type="text/css" rel="stylesheet"/>
    <link href="css/style.css" type="text/css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/notosanskr" rel="stylesheet">
    <style>

    </style>
</head>
<body>

    <div class="map-container">
        <div id="map" class="map-container"></div>
    </div>
    <div class="map-mask">
        <div class="progress">0%</div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/swiper.jquery.min.js"></script>
    <script src="js/jquery.touchSwipe.min.js"></script>
    <script>
        var map;
        var marker;
        var mapBoundary;
        var markerLayer;
        var requestMarkerLayer;
        var vectorLayer;
        var virtualVectorLayer;
        var maskLayer;
        var tData;
        var size;
        var offset;
        var caIcon;
        var destIcon;
        var resultIndex = 0;
        var errorCount = 0;
        var headers = new Array();
        var headersMulti = new Array();
        headers["appKey"]="8e88ce86-83f7-46b5-9272-16b581b04ae8";
        headersMulti["appKey"]="8e88ce86-83f7-46b5-9272-16b581b04ae8";
        headersMulti["Content-Type"]="application/json";

        function initMap(){
            map = new Tmap.Map({
                div:'map'
            });

            var lonlat = new Tmap.LonLat(14129410, 4507355)
            map.setCenter(lonlat, 14);
            map.events.register("click", map, createNewRequest);


            mapBoundary = map.getExtent().transform("EPSG:3857", "EPSG:4326");
            tData = new Tmap.TData();
            vectorLayer = new Tmap.Layer.Vector("vectorLayerID");
            virtualVectorLayer = new Tmap.Layer.Vector("vectorLayerID");
            markerLayer = new Tmap.Layer.Markers();
            requestMarkerLayer = new Tmap.Layer.Markers();

            var maskStyle = {
                fillColor:'FF0000',
                fillOpacity:0.8
            };

            var pointlist = [];
                pointlist.push(new Tmap.Geometry.Point(mapBoundary.left, mapBoundary.top).transform("EPSG:4326", "EPSG:3857"));
                pointlist.push(new Tmap.Geometry.Point(mapBoundary.right, mapBoundary.top).transform("EPSG:4326", "EPSG:3857"));
                pointlist.push(new Tmap.Geometry.Point(mapBoundary.right, mapBoundary.bottom).transform("EPSG:4326", "EPSG:3857"));
                pointlist.push(new Tmap.Geometry.Point(mapBoundary.left, mapBoundary.bottom).transform("EPSG:4326", "EPSG:3857"));
                pointlist.push(new Tmap.Geometry.Point(mapBoundary.left, mapBoundary.top).transform("EPSG:4326", "EPSG:3857"));

            var square = new Tmap.Geometry.LinearRing(pointlist);
            var squareFeature = new Tmap.Feature.Vector(square, null, maskStyle); // 백터 생성
            maskLayer = new Tmap.Layer.Vector("vectorLayerID");
            map.addLayer(maskLayer);
            maskLayer.addFeatures([squareFeature]);

            size = new Tmap.Size(48,48);
            offset = new Tmap.Pixel(-(size.w/2), -(size.h/2));
            carIcon = new Tmap.Icon('/img/car.png');
            destIcon = new Tmap.Icon('/img/destination.png');

            map.addLayer(markerLayer);
            map.addLayer(requestMarkerLayer);
        }

        $(document).ready(function() {
            initMap();
            map.ctrl_nav.disableZoomWheel();
            map.ctrl_nav.dragPan.deactivate();
        });

        function clickMap(e){
            markerLayer.removeMarker(marker); // 기존 마커 삭제
            var lonlat = map.getLonLatFromViewPortPx(e.xy).transform("EPSG:3857", "EPSG:4326");
            marker = new Tmap.Marker(lonlat.transform("EPSG:4326", "EPSG:3857"));
            markerLayer.addMarker(marker);
        }

        // 입력한 숫자대로 차량 객체 생성
        var vehiArray = new Array();

        function createVehiArray(count){
            for(var i=0 ; i<count ; i++){
                vehiArray.push(addVehicle(i));
            }
        }


        // 차량 객체 생성
        function addVehicle(i){
            var vehicleObj = new Vehicle(i);
            vehicleObj.initVehicle();
            vehicleObj.initDestination();
            return vehicleObj;
        }

        // 차량 Class 정의
        function Vehicle(index){
            this.index              = index;
            this.lat                = (Math.random()*(mapBoundary.right-mapBoundary.left))+mapBoundary.left;
            this.lon                = (Math.random()*(mapBoundary.bottom-mapBoundary.top)) + mapBoundary.top;
            this.currentLocation    = new Tmap.LonLat(this.lat, this.lon).transform("EPSG:4326", "EPSG:3857");
            this.destination;
            this.marker     = new Tmap.Marker(this.currentLocation, new Tmap.Icon('/img/car.png', size, offset));
            this.selectFlag = false;
            this.route;
            this.routeVector;
            this.totalTime;
        }

        Vehicle.prototype = {
            initVehicle  : function(){
                this.marker.index = this.index;
                markerLayer.addMarker(this.marker);
            },
            initDestination : function(){
                var lat = (Math.random()*(mapBoundary.right-mapBoundary.left))+mapBoundary.left;
                var lon = (Math.random()*(mapBoundary.bottom-mapBoundary.top)) + mapBoundary.top;
                this.desination = new Tmap.LonLat(lat, lon);
                this.desination.transform("EPSG:4326", "EPSG:3857");
            },
            requestRoute : function(){
                $.ajax({
                    method:"POST",
                    headers : headers,
                    url:"https://api2.sktelecom.com/tmap/routes?version=2&format=json",
                        data:{
                        startX : this.currentLocation.lon,
                        startY : this.currentLocation.lat,
                        endX : this.desination.lon,
                        endY : this.desination.lat,
                        reqCoordType : "EPSG3857",
                        resCoordType : "EPSG3857",
                        searchOption : 0
                    },
                    success:function(response){
                        if(response){
                            drawRoute(response);
                        }
                    }
                })

            },
            toggleRoute : function(){
                console.log(vehiArray[this.index]);
                if(vehiArray[this.index].selectFlag==false){
                    drawRoute(vehiArray[this.index].route);
                }else{
                    vehiArray[this.index].selectFlag=false;
                }
            }
        }

        // 경로정보를 받아오기
        function requestByAjax(index){
            $(".map-mask").fadeIn();
            $.ajax({
                method:"POST",
                headers : headers,
                url:"https://api2.sktelecom.com/tmap/routes?version=2&format=json",
                    data:{
                    startX : vehiArray[index].currentLocation.lon,
                    startY : vehiArray[index].currentLocation.lat,
                    endX : vehiArray[index].desination.lon,
                    endY : vehiArray[index].desination.lat,
                    reqCoordType : "EPSG3857",
                    resCoordType : "EPSG3857",
                    searchOption : 0
                },
                success:function(response){
                    if(response) {
                        console.log(resultIndex + " : sucess");
                        vehiArray[resultIndex].route = response;
                        drawRoute(response);
                        $(".progress").html(Math.floor((resultIndex/vehiArray.length)*100) + "%");
                        setTimeout(function(){requestNext()}, 100);
                    }else{
                        console.log(resultIndex + " : no result");
                        setTimeout(function(){requestNext()}, 100);
                    }
                },
                error:function(){
                    console.log(resultIndex + " : error");
                    resultIndex--;
                    setTimeout(function(){requestNext()}, 500);
                }
            })
        };

        // 하나가 완료되면 다음 객체의 값을 받아오기
        function requestNext(){
            resultIndex++;
            if(resultIndex<vehiArray.length){
                requestByAjax(resultIndex);
           }else{
               resultIndex=0;
               $(".progress").html("100%");
               $(".map-mask").fadeOut();
           }
        }

        // 경로정보로 경로 그리기
        function drawRoute(route){
            var jsonForm = new Tmap.Format.GeoJSON({extractStyles:false}).read(route);
            vectorLayer.addFeatures(jsonForm);
            vectorLayer.styleMap.styles.default.defaultStyle = {
                pointRadius : 1,
                strokeColor: "#ff4474",
                strokeOpacity: 0.5,
                strokeWidth: 1,
                strokeDashstyle: "solid"
            };
            map.addLayer(vectorLayer);
        }

        var requestMarker;
        var newRequestFlag=0;

        // 새로운 경로 요청
        function createNewRequest(e){
            if(newRequestFlag==0){
                createNewStart(e);
            }else if(newRequestFlag==1){
                createNewEnd(e);
            }else{
                clearRequest();
            }
        }

        // 요청 Class 정의
        function Rider(index){
            this.currentLocation;
            this.destination;
        }

        var rider = new Rider();


        // 새로운 출발지
        function createNewStart(e){
            newRequestFlag=1;
            rider.currentLocation = map.getLonLatFromViewPortPx(e.xy).transform("EPSG:3857", "EPSG:4326");
            var icon = new Tmap.Icon('http://tmapapis.sktelecom.com/upload/tmap/marker/pin_b_m_a.png',{w:24, h:38}, {x: -12, y: -38});
            requestMarker = new Tmap.Marker(rider.currentLocation.transform("EPSG:4326", "EPSG:3857"), icon);
            requestMarkerLayer.addMarker(requestMarker);
        }

        // 새로운 도착지
        function createNewEnd(e){
            newRequestFlag=2;
            rider.desination = map.getLonLatFromViewPortPx(e.xy).transform("EPSG:3857", "EPSG:4326");
            var icon = new Tmap.Icon('http://tmapapis.sktelecom.com/upload/tmap/marker/pin_b_m_b.png',{w:24, h:38}, {x: -12, y: -38});
            requestMarker = new Tmap.Marker(rider.desination.transform("EPSG:4326", "EPSG:3857"), icon);
            requestMarkerLayer.addMarker(requestMarker);

            requestDispatch();
        }

        // 요청 지우기
        function clearRequest(){
            newRequestFlag=0;
            rider = new Rider();
            requestMarkerLayer.clearMarkers();
        }

        var altIndex = 0;

        // 새로운 요청을 배차하기
        function requestDispatch(){
            searchAlt();
            $(".progress").html("0%");
            $(".map-mask").fadeIn();
        }

        // 다중 경유지 적용해서 확인할 수 있게 수정필요
        function searchRoute(start, via1, via2, via3){
            var startX = String(start.lon);
            var startY = String(start.lat);
            var endX = String(via1.lon);
            var endY = String(via1.lat);
            var viaX1 = String(via2.lon);
            var viaY1 = String(via2.lat);
            var viaX2 = String(via3.lon);
            var viaY2 = String(via3.lat);


            $.ajax({
                method:"POST",
                headers : headersMulti,
                url:"https://api2.sktelecom.com/tmap/routes/routeSequential30?version=1&format=json",
                async:false,
                data:JSON.stringify({
                    "startName" : "start",
                    "startX" : startX,
                    "startY" : startY,
                    "startTime" : "201908011200",
                    "endName" : "end",
                    "endX" : endX,
                    "endY" : endY,
                    "viaPoints" :
                        [{
                                 "viaPointId" : "viaStart",
                                 "viaPointName" : "viaStart",
                                 "viaX" : viaX1 ,
                                 "viaY" : viaY1
                        },{
                                 "viaPointId" : "viaEnd",
                                 "viaPointName" : "viaEnd",
                                 "viaX" : viaX2 ,
                                 "viaY" : viaY2
                        }],
                    "reqCoordType" : "EPSG3857",
                    "resCoordType" : "EPSG3857",
                    "searchOption": 0
                }),
                success:function(response){
                    console.log(response.properties.totalTime);
                    if(response) {
                        console.log(altIndex + " : " + resultIndex + " : sucess");
                        if(response.properties.totalTime<vehiArray[resultIndex].totalTime || vehiArray[resultIndex].totalTime==undefined){
                            vehiArray[resultIndex].route = response;
                            vehiArray[resultIndex].totalTime = response.properties.totalTime;
                        }
                        drawVirtualRoute(response);
                        $(".progress").html(Math.floor((((resultIndex*3)+altIndex)/(vehiArray.length*3))*100) + "%");
                        setTimeout(function(){searchAlt()}, 1000);
                    }else{
                        console.log(resultIndex + " : no result");
                        setTimeout(function(){searchAlt()}, 1000);
                    }
                },
                error:function(request,status,error){
                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    altIndex--;
                    if(altIndex==-1){
                        altIndex=0;
                        resultIndex--;
                    }
                    errorCount++;
                    if(errorCount>50){resultIndex=vehiArray.length}
                    setTimeout(function(){searchAlt()}, 500);
                }
            });
        };
        function searchAlt(){
            altIndex++;
            if(altIndex==1){
                searchRoute(vehiArray[resultIndex].currentLocation, rider.currentLocation, rider.desination, vehiArray[resultIndex].desination);
            }else if(altIndex==2){
                searchRoute(vehiArray[resultIndex].currentLocation, rider.currentLocation, vehiArray[resultIndex].desination, rider.desination);
            }else if(altIndex==3){
                searchRoute(vehiArray[resultIndex].currentLocation, vehiArray[resultIndex].desination, rider.currentLocation, rider.desination);
            }else{
                resultIndex++;
                if(resultIndex<vehiArray.length){
                    altIndex=0;
                    searchRoute(vehiArray[resultIndex].currentLocation, rider.currentLocation, rider.desination, vehiArray[resultIndex].desination);
                }else{
                    console.log("finish!!!");
                    altIndex=0;
                    resultIndex=0;
                    errorCount=0;
                    $(".progress").html("100%");
                    $(".map-mask").fadeOut();
                    selectFinalRoute();
                }
            }
        }

        // 경로정보로 경로 그리기
        function drawVirtualRoute(route){
            var jsonForm = new Tmap.Format.GeoJSON({extractStyles:false}).read(route);
            virtualVectorLayer.addFeatures(jsonForm);
            virtualVectorLayer.styleMap.styles.default.defaultStyle = {
                pointRadius : 1,
                strokeColor: "#3cffea",
                strokeOpacity: 0.1,
                strokeWidth: 1,
                strokeDashstyle: "solid"
            };
            map.addLayer(virtualVectorLayer);
        }

        var finalVehicle;

        // 가장 짧은 시간 경로 선택하기
        function selectFinalRoute(){
            var index=0;
            var time=0;
            for(var i=0 ; i<vehiArray.length ; i++){
                if(time==0){
                    time = vehiArray[index].totalTime;
                }
                if(time>vehiArray[index].totalTime){
                    index = i;
                    time = vehiArray[index].totalTime;
                }
            }
            console.log(index);
            finalVehicle = index;
            drawFinalRoute(vehiArray[finalVehicle].route);
        }

        function drawFinalRoute(route){
            var jsonForm = new Tmap.Format.GeoJSON({extractStyles:false}).read(route);
            virtualVectorLayer.addFeatures(jsonForm);
            virtualVectorLayer.styleMap.styles.default.defaultStyle = {
                pointRadius : 1,
                strokeColor: "#7200c7",
                strokeOpacity: 0.9,
                strokeWidth: 3,
                strokeDashstyle: "solid"
            };
            map.addLayer(virtualVectorLayer);
        }

        // 수정된 검색 function
        function compareRoute(start, end, via1, via2){
            // 1: start - end

            // 2: start - via1

            // 3: end - via1

            // 4: end - via2

            // 5: via1 - end

            // 6: via1 - via2

            // 7: via2 - end

            // 1 > 3 > 6

            // 2 > 5 > 4

            // 2 > 6 > 7
        }

    </script>
    <script src="https://api2.sktelecom.com/tmap/js?version=1&format=javascript&appKey=8e88ce86-83f7-46b5-9272-16b581b04ae8"></script>

</body>
</html>
