<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <title>Facade View</title>
    <!-- CSS  -->
    <link href="css/swiper.css" type="text/css" rel="stylesheet"/>
    <link href="css/style.css" type="text/css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/notosanskr" rel="stylesheet">
    <style>
        *{
            margin: 0px;
            padding: 0px;
        }
        html, body {
            color: rgb(255,255,255);
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 200;
        }
        .map-container{
            width: 100%;
            height: 100%;
        }
        .map-mask{
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9)
        }
        #lineStyle{
            width: 1px;
        }
    </style>
</head>
<body>

    <div id="map" class="map-container"></div>
    <div class="map-mask"></div>

    <script src="js/jquery.min.js"></script>
    <script src="js/swiper.jquery.min.js"></script>
    <script src="js/jquery.touchSwipe.min.js"></script>
    <script>
        var map;
        var marker;
        var markerLayer;
        var mapBoundary;
        var tData;
        var vectorLayer;

        function initMap(){
            map = new Tmap.Map({
                div:'map'
            });

            var lonlat = new Tmap.LonLat(14129410, 4507355)
            map.setCenter(lonlat, 14);

            map.events.register("click", map, clickMap);
            mapBoundary = map.getExtent().transform("EPSG:3857", "EPSG:4326");
            tData = new Tmap.TData();
            vectorLayer = new Tmap.Layer.Vector("vectorLayerID");
            markerLayer = new Tmap.Layer.Markers();
            map.addLayer(markerLayer);
        }

        $(document).ready(function() {
            initMap();
            map.ctrl_nav.disableZoomWheel();
            map.ctrl_nav.dragPan.deactivate();
        });

        function clickMap(e){
            markerLayer.removeMarker(marker); // 기존 마커 삭제
            var lonlat = map.getLonLatFromViewPortPx(e.xy).transform("EPSG:3857", "EPSG:4326");
            marker = new Tmap.Marker(lonlat.transform("EPSG:4326", "EPSG:3857"));
            markerLayer.addMarker(marker);
        }

        // 입력한 숫자대로 차량 객체 생성

        var vehiArray = new Array();

        function createVehiArray(count){
            for(var i=0 ; i<count ; i++){
                vehiArray.push(addVehicle(i));
            }
        }

        function updateRoute(){
            for(var i=0 ; i<vehiArray.length ; i++){
                vehiArray[i].requestRoute();
            }
        }

        var headers = new Array();
        headers["appKey"]="8e88ce86-83f7-46b5-9272-16b581b04ae8";


        // 이걸로 다 뜯어고치자
        function requestByAjax(){
            $.ajax({
                method:"POST",
                headers : headers,
                url:"https://api2.sktelecom.com/tmap/routes?version=2&format=json",
                    data:{
                    startX : "126.9850380932383",
                    startY : "37.566567545861645",
                    endX : "127.10331814639885",
                    endY : "37.403049076341794",
                    reqCoordType : "WGS84GEO",
                    resCoordType : "WGS84GEO",
                    searchOption : 0
                },
                success:function(response){
                    if( response ) {
                        console.log(response);
                        var features = response.features;
                        var coordinates = [];
                        for(var i in features) {
                            if( features[i].geometry.type == "Point" ) {
                                /* 타입이 Point 인 경우만 출력 */
                                coordinates = features[i].geometry.coordinates;
                                console.log("lon :" + coordinates[0] + " / lat :" + coordinates[1]);
                            }
                        }
                    }
                }
            })
        };


        // 차량 객체 생성
        function addVehicle(i){
            var vehicleObj = new Vehicle(i);
            vehicleObj.initVehicle();
            vehicleObj.initDestination();
            vehicleObj.requestRoute();
            return vehicleObj;
        }


        // 차량 Class 정의
        function Vehicle(index){
            this.index              = index;
            this.lat                = (Math.random()*(mapBoundary.right-mapBoundary.left))+mapBoundary.left;
            this.lon                = (Math.random()*(mapBoundary.bottom-mapBoundary.top)) + mapBoundary.top;
            this.currentLocation    = new Tmap.LonLat(this.lat, this.lon).transform("EPSG:4326", "EPSG:3857");
            this.destination;
            this.marker     = new Tmap.Marker(this.currentLocation);
            this.selectFlag = false;
            this.routeVector;
            this.tData = new Tmap.TData();
            this.tData.index = index;

        }

        Vehicle.prototype = {
            initVehicle  : function(){
                this.marker.index = this.index;
                markerLayer.addMarker(this.marker);
        		this.marker.events.register("click", marker, this.toggleRoute);

            },
            initDestination : function(){
                var lat = (Math.random()*(mapBoundary.right-mapBoundary.left))+mapBoundary.left;
                var lon = (Math.random()*(mapBoundary.bottom-mapBoundary.top)) + mapBoundary.top;
                this.desination = new Tmap.LonLat(lat, lon);
                this.desination.transform("EPSG:4326", "EPSG:3857");
                markerLayer.addMarker(new Tmap.Marker(this.desination));
            },
            requestRoute : function(){
                console.log("startx :"+this.currentLocation.lon+", starty : "+this.currentLocation.lat+", endx : "+this.desination.lon+", endy : "+this.desination.lat)
                $.ajax({
                    method:"POST",
                    headers : headers,
                    url:"https://api2.sktelecom.com/tmap/routes?version=2&format=json",
                        data:{
                        startX : this.currentLocation.lon,
                        startY : this.currentLocation.lat,
                        endX : this.desination.lon,
                        endY : this.desination.lat,
                        reqCoordType : "EPSG3857",
                        resCoordType : "EPSG3857",
                        searchOption : 0
                    },
                    success:function(response){
                        if( response ) {
                            console.log(response);

                            // 이 responce를 어떻게 파싱할지가 다음 단계
                            routeVector = response;
                            var features = response.features;
                            var coordinates = [];
                            for(var i in features) {
                                if( features[i].geometry.type == "Point" ) {
                                    coordinates = features[i].geometry.coordinates;
                                }
                            }
                        }
                    }
                })

            },
            initRoute : function(){
                console.log(this.index + " : " +this.responseXML); //xml로 데이터를 받은 정보들을 콘솔창에서 확인할 수 있습니다.
                vehiArray[this.index].routeVector = new Tmap.Format.KML({extractStyles:false}).read(this.responseXML);
            },
            toggleRoute : function(){
                console.log(vehiArray[this.index]);
                if(vehiArray[this.index].selectFlag==false){
                    console.log(vehiArray[this.index].selectFlag);
                    vectorLayer.addFeatures(vehiArray[this.index].routeVector);
                    map.addLayer(vectorLayer);
                    vehiArray[this.index].selectFlag=true;
                }else{
                    map.removeLayer(vectorLayer);
                    vehiArray[this.index].selectFlag=false;
                }
            }
        }



    </script>
    <script src="https://api2.sktelecom.com/tmap/js?version=1&format=javascript&appKey=8e88ce86-83f7-46b5-9272-16b581b04ae8"></script>

</body>
</html>
